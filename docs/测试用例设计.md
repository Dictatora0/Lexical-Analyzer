# Mini 语言词法分析器测试用例设计文档

## 测试设计理念

### 测试目标

1. **功能完整性测试**：验证所有 Token 类型都能正确识别
2. **边界条件测试**：测试极端情况和边界值
3. **错误处理测试**：验证词法错误能被正确检测和恢复
4. **性能测试**：验证大文件和复杂代码的处理能力
5. **兼容性测试**：验证各版本功能的向后兼容性

### 测试分类

```
测试体系
├── 功能性测试（Functional Testing）
│   ├── 基础功能测试
│   ├── 高级扩展功能测试（浮点数/字符串/注释等）
│   └── 高级特性测试（科学计数法/逻辑运算符/自增自减等）
├── 边界测试（Boundary Testing）
│   ├── 数值边界
│   ├── 字符串边界
│   └── 标识符边界
├── 错误测试（Error Testing）
│   ├── 词法错误
│   ├── 格式错误
│   └── 边界越界
├── 压力测试（Stress Testing）
│   ├── 大文件测试
│   ├── 深度嵌套测试
│   └── 复杂表达式测试
└── 回归测试（Regression Testing）
    ├── 版本兼容性
    └── 功能稳定性
```

---

## 测试用例矩阵

### 1. 基础功能测试

| 测试项 | 测试内容         | 测试文件              | 预期结果    |
| ------ | ---------------- | --------------------- | ----------- |
| 关键字 | 所有 8 个关键字  | test_keywords.mini    | ✅ 正确识别 |
| 标识符 | 合法变量名       | test_identifiers.mini | ✅ 正确识别 |
| 整数   | 整数常量         | test_integers.mini    | ✅ 正确识别 |
| 运算符 | 基本运算符       | test_operators.mini   | ✅ 正确识别 |
| 分隔符 | 括号、分号等     | test_delimiters.mini  | ✅ 正确识别 |
| 注释   | 块注释和单行注释 | test_comments.mini    | ✅ 正确跳过 |

### 2. 高级扩展功能测试

| 测试项   | 测试内容          | 测试文件         | 预期结果     |
| -------- | ----------------- | ---------------- | ------------ |
| 浮点数   | 小数点数值        | test_float.mini  | ✅ 正确识别  |
| 字符串   | 单双引号字符串    | test_string.mini | ✅ 正确识别  |
| 转义字符 | \n, \t, \\, \" 等 | test_escape.mini | ✅ 正确处理  |
| 哈希优化 | 符号表/常数表查找 | test_hash.mini   | ✅ O(1) 查找 |

### 3. 高级特性测试

| 测试项     | 测试内容     | 测试文件             | 预期结果     |
| ---------- | ------------ | -------------------- | ------------ |
| 科学计数法 | e/E 指数格式 | test_scientific.mini | ✅ 正确识别  |
| 逻辑运算符 | &&, \|\|     | test_logic.mini      | ✅ 正确识别  |
| 自增自减   | ++, --       | test_increment.mini  | ✅ 正确识别  |
| Tab 处理   | 制表位列号   | test_tab.mini        | ✅ 列号准确  |
| 生成器     | 内存优化     | test_generator.mini  | ✅ O(1) 内存 |

### 4. 边界测试

| 测试项       | 边界条件  | 测试文件                  | 预期结果    |
| ------------ | --------- | ------------------------- | ----------- |
| 最小整数     | 0         | test_boundary_int.mini    | ✅ 正确识别 |
| 最大整数     | 999999999 | test_boundary_int.mini    | ✅ 正确识别 |
| 最小浮点数   | 0.0       | test_boundary_float.mini  | ✅ 正确识别 |
| 极小科学计数 | 1e-999    | test_boundary_sci.mini    | ✅ 正确识别 |
| 极大科学计数 | 1e+999    | test_boundary_sci.mini    | ✅ 正确识别 |
| 空字符串     | ""        | test_boundary_string.mini | ✅ 正确识别 |
| 长字符串     | 1000 字符 | test_boundary_string.mini | ✅ 正确识别 |
| 单字符标识符 | a, x      | test_boundary_id.mini     | ✅ 正确识别 |
| 长标识符     | 100 字符  | test_boundary_id.mini     | ✅ 正确识别 |

### 5. 错误测试（核心）

#### 5.1 词法错误

| 错误类型       | 错误示例        | 测试文件                         | 预期行为      |
| -------------- | --------------- | -------------------------------- | ------------- |
| 非法字符       | @, #, $         | test_error_illegal_char.mini     | ❌ 报错并恢复 |
| 非法运算符     | !, &, \| (单个) | test_error_illegal_op.mini       | ❌ 报错并恢复 |
| 未闭合字符串   | "hello          | test_error_unclosed_string.mini  | ❌ 报错并恢复 |
| 未闭合注释     | /\* comment     | test_error_unclosed_comment.mini | ❌ 报错       |
| 非法转义       | "\k", "\x"      | test_error_illegal_escape.mini   | ❌ 报错并恢复 |
| 非法数字       | 12.34.56        | test_error_illegal_number.mini   | ❌ 报错并恢复 |
| 科学计数法错误 | 1.2e, 1.2e-     | test_error_scientific.mini       | ❌ 报错       |
| 标识符非法开头 | 123abc          | test_error_identifier.mini       | ❌ 报错并恢复 |

#### 5.2 格式错误

| 错误类型      | 错误示例  | 测试文件                     | 预期行为    |
| ------------- | --------- | ---------------------------- | ----------- |
| 空文件        | (空)      | test_error_empty.mini        | ⚠️ 只有 EOF |
| 只有空白      | 空格/换行 | test_error_whitespace.mini   | ⚠️ 只有 EOF |
| 混合 Tab/空格 | 混合缩进  | test_error_mixed_indent.mini | ✅ 正确处理 |

#### 5.3 边界越界

| 错误类型     | 错误示例   | 测试文件                  | 预期行为    |
| ------------ | ---------- | ------------------------- | ----------- |
| 错误数量超限 | 15 个错误  | test_error_overflow.mini  | ❌ 中断分析 |
| 极长行       | 10000 字符 | test_error_long_line.mini | ✅ 正确处理 |

### 6. 压力测试

| 测试项     | 测试规模    | 测试文件                     | 预期结果      |
| ---------- | ----------- | ---------------------------- | ------------- |
| 大量标识符 | 1000+ 变量  | test_stress_identifiers.mini | ✅ 哈希表高效 |
| 大量常数   | 1000+ 常量  | test_stress_constants.mini   | ✅ 哈希表高效 |
| 深度嵌套   | 50 层嵌套   | test_stress_nesting.mini     | ✅ 正确处理   |
| 复杂表达式 | 100+ 运算符 | test_stress_expression.mini  | ✅ 正确识别   |
| 大文件     | 10000+ 行   | test_stress_large_file.mini  | ✅ 生成器高效 |

---

## 测试设计原则

### 1. 等价类划分（Equivalence Partitioning）

将输入划分为等价类，每类选择代表性测试：

#### 数值等价类

- **有效等价类**：
  - 整数：`0`, `123`, `999999`
  - 浮点数：`0.0`, `3.14`, `999.999`
  - 科学计数法：`1e5`, `1.2e-5`, `3.0E+10`
- **无效等价类**：
  - 多个小数点：`12.34.56`
  - 错误科学计数法：`1.2e`, `1.2e--`
  - 非法字符混入：`12a34`

#### 字符串等价类

- **有效等价类**：
  - 空字符串：`""`
  - 普通字符串：`"hello"`
  - 带转义：`"hello\nworld"`
- **无效等价类**：
  - 未闭合：`"hello`
  - 非法转义：`"\k"`

#### 标识符等价类

- **有效等价类**：
  - 单字符：`a`, `x`
  - 多字符：`count`, `maxValue`
  - 下划线：`_temp`, `my_var`
- **无效等价类**：
  - 数字开头：`123abc`
  - 特殊字符：`my-var`, `my.var`

### 2. 边界值分析（Boundary Value Analysis）

测试边界及其附近的值：

| 类型       | 下界-1    | 下界      | 正常值     | 上界        | 上界+1    |
| ---------- | --------- | --------- | ---------- | ----------- | --------- |
| 整数       | -         | 0         | 123        | 999999999   | -         |
| 标识符长度 | 0 字符 ❌ | 1 字符 ✅ | 10 字符 ✅ | 100 字符 ✅ | -         |
| 错误数量   | 0         | 1         | 5          | 10          | 11❌ 中断 |

### 3. 错误推测（Error Guessing）

基于经验推测可能的错误：

#### 常见错误模式

1. **遗漏闭合符号**：`"hello`, `/* comment`
2. **运算符混淆**：`=` vs `==`, `&` vs `&&`
3. **转义字符错误**：`\k`, `\x`
4. **数字格式错误**：`12.`, `.34`, `1.2e`
5. **标识符命名错误**：`123abc`, `my-var`

#### 特殊场景

1. **空文件**：测试 EOF 处理
2. **只有注释**：测试注释跳过
3. **连续错误**：测试错误恢复
4. **错误超限**：测试中断机制

### 4. 因果图法（Cause-Effect Graphing）

分析输入条件与输出的因果关系：

#### 示例：科学计数法识别

```
输入条件：
C1: 有数字
C2: 有小数点
C3: 有 e/E
C4: 有 +/-
C5: 指数部分有数字

输出：
E1: 识别为整数
E2: 识别为浮点数
E3: 识别为科学计数法
E4: 报错

因果关系：
- C1 ∧ ¬C2 ∧ ¬C3 → E1
- C1 ∧ C2 ∧ ¬C3 → E2
- C1 ∧ C3 ∧ C5 → E3
- C1 ∧ C3 ∧ ¬C5 → E4
```

### 5. 状态转换测试（State Transition Testing）

测试状态机的各种转换路径：

#### 示例：字符串状态机

```
状态：
S0: 初始
S1: 读取中
S2: 转义
S3: 结束

转换：
S0 --["]-->  S1
S1 --[普通字符]--> S1
S1 --[\]--> S2
S2 --[n,t,r,",',\]--> S1
S2 --[其他]--> 错误
S1 --["]-->  S3
S1 --[EOF]--> 错误
```

---

## 测试用例详细设计

### 类别 1：基础功能测试

#### TC-001: 关键字识别

**测试目的**：验证所有关键字能被正确识别

**测试代码**：

```c
// test_keywords.mini
if else while int return void
```

**预期结果**：

- 6 个关键字 Token
- 类型码分别为 1, 2, 3, 4, 5, 6

#### TC-002: 标识符识别

**测试目的**：验证合法标识符识别

**测试代码**：

```c
// test_identifiers.mini
a x count maxValue my_var _temp
```

**预期结果**：

- 6 个标识符 Token
- 都在符号表中
- 索引从 0 到 5

### 类别 2：边界测试

#### TC-101: 数值边界

**测试目的**：验证极端数值的处理

**测试代码**：

```c
// test_boundary_numbers.mini
int zero = 0;
int max = 999999999;
int tiny = 1e-999;
int huge = 1e+999;
```

**预期结果**：

- 所有数值正确识别
- 科学计数法正确转换

#### TC-102: 字符串边界

**测试目的**：验证特殊字符串

**测试代码**：

```c
// test_boundary_strings.mini
int empty = "";
int single = "a";
int escape = "\n\t\r\"\'\\";
```

**预期结果**：

- 空字符串正确识别
- 转义字符正确处理

### 类别 3：错误测试（核心）

#### TC-201: 非法字符

**测试目的**：验证非法字符检测

**测试代码**：

```c
// test_error_illegal_char.mini
int a @ 10;
int b # 20;
int c $ 30;
```

**预期结果**：

- 检测到 3 个词法错误
- 错误信息：`非法字符 '@'` 等
- 继续分析后续代码

#### TC-202: 未闭合字符串

**测试目的**：验证字符串闭合检测

**测试代码**：

```c
// test_error_unclosed_string.mini
int str1 = "hello world;
int str2 = 'test;
int str3 = "normal";
```

**预期结果**：

- 检测到 2 个错误（未闭合字符串）
- str3 正确识别（错误恢复成功）

#### TC-203: 科学计数法错误

**测试目的**：验证科学计数法格式检查

**测试代码**：

```c
// test_error_scientific.mini
int e1 = 1.2e;
int e2 = 1.2e-;
int e3 = 1.2e+;
int e4 = 1.2eabc;
int ok = 1.2e5;
```

**预期结果**：

- 前 4 个报错：`指数后缺少数字`
- 最后 1 个正确识别（错误恢复）

#### TC-204: 非法运算符

**测试目的**：验证单独的 !、&、| 检测

**测试代码**：

```c
// test_error_illegal_op.mini
int a = 10 & 20;
int b = 30 | 40;
if (!flag) { }
```

**预期结果**：

- 3 个词法错误
- 提示：`非法字符 '&'` 等

#### TC-205: 错误超限

**测试目的**：验证错误数量限制

**测试代码**：

```c
// test_error_overflow.mini
int a @ 1;
int b # 2;
int c $ 3;
// ... 共 15 个错误
```

**预期结果**：

- 检测到 10 个错误后中断
- 提示：`错误过多，分析中断`

### 类别 4：压力测试

#### TC-301: 大量标识符

**测试目的**：验证哈希表性能

**测试代码**：

```c
// test_stress_identifiers.mini（生成）
int var0 = 0;
int var1 = 1;
// ... 1000 个变量
```

**预期结果**：

- 符号表包含 1000 个标识符
- 查找时间 O(1)

#### TC-302: 深度嵌套

**测试目的**：验证嵌套结构处理

**测试代码**：

```c
// test_stress_nesting.mini
if (a) {
  if (b) {
    if (c) {
      // ... 50 层嵌套
    }
  }
}
```

**预期结果**：

- 所有括号正确识别
- 无栈溢出

---

## 测试覆盖度目标

### 代码覆盖度

- **语句覆盖**：≥ 95%
- **分支覆盖**：≥ 90%
- **路径覆盖**：≥ 85%

### 功能覆盖度

- **Token 类型覆盖**：100% (32/32)
- **错误类型覆盖**：100% (8/8)
- **边界条件覆盖**：≥ 90%

### 测试执行统计

- **测试用例总数**：≥ 30
- **正确用例**：~20 (67%)
- **错误用例**：~10 (33%)

---

## 测试执行策略

### 1. 单元测试

- 每个功能独立测试
- 使用专门的测试文件
- 自动化测试脚本

### 2. 集成测试

- 多功能组合测试
- 真实场景模拟
- 综合测试用例

### 3. 回归测试

- 版本升级后重新测试
- 确保向后兼容
- 功能稳定性验证

### 4. 压力测试

- 大文件测试
- 复杂代码测试
- 性能基准测试

---

## 测试工具和脚本

### 自动化测试脚本

```bash
# 运行所有测试
./run_all_tests.sh

# 运行特定类别
./run_tests.sh --category error
./run_tests.sh --category boundary
./run_tests.sh --category stress
```

### 测试报告生成

```bash
# 生成详细报告
python test_runner.py --report

# 覆盖度分析
python coverage_analyzer.py
```

---

## 测试评估标准

### 通过标准

1. **功能正确性**：所有正确用例通过
2. **错误检测**：所有错误用例能检测并恢复
3. **性能达标**：大文件测试在可接受时间内完成
4. **覆盖度**：代码覆盖度 ≥ 90%

### 质量指标

- **测试用例通过率**：≥ 95%
- **错误检测率**：100%
- **错误恢复率**：≥ 90%
- **性能达标率**：100%

---

## 测试维护

### 新增功能测试

1. 为每个新功能设计测试用例
2. 包括正确和错误场景
3. 更新测试文档

### 缺陷修复测试

1. 为每个缺陷创建回归测试
2. 验证修复效果
3. 防止重复出现

### 测试用例评审

- 定期评审测试覆盖度
- 补充遗漏的测试场景
- 优化测试效率

---

**文档版本**: 1.0  
**最后更新**: 2024 年  
**适用范围**: 当前 Mini 词法分析器实现（包含基础功能、扩展特性和高级特性）
