# Mini 语言词法分析器实验报告

## 一、实验目的

1. 理解词法分析在编译过程中的作用
2. 掌握词法分析器的设计原理和实现方法
3. 熟悉正规式、有限自动机等理论知识的实际应用
4. 学习符号表、常数表等数据结构的设计与管理
5. 掌握词法错误检测与处理方法

## 二、实验内容

设计并实现一个 Mini 语言的词法分析器，能够：

- 识别 Mini 语言的所有词法单元（关键字、标识符、常量、运算符、界限符）
- 生成 Token 序列
- 构建并维护符号表和常数表
- 检测并报告词法错误
- 处理注释和空白符

## 三、Mini 语言词汇表

| **Token 类型** | **类别码** | **字符串形式**           | **属性值说明** |
| -------------- | ---------- | ------------------------ | -------------- |
| **关键字**     |            |                          |                |
| if             | 1          | if                       | -              |
| else           | 2          | else                     | -              |
| while          | 3          | while                    | -              |
| int            | 4          | int                      | -              |
| return         | 5          | return                   | -              |
| **运算符**     |            |                          |                |
| 加法           | 6          | +                        | -              |
| 减法           | 7          | -                        | -              |
| 乘法           | 8          | \*                       | -              |
| 除法           | 9          | /                        | -              |
| 赋值           | 10         | =                        | -              |
| 等于           | 11         | ==                       | -              |
| 不等于         | 12         | !=                       | -              |
| 小于           | 13         | <                        | -              |
| 小于等于       | 14         | <=                       | -              |
| 大于           | 15         | >                        | -              |
| 大于等于       | 16         | >=                       | -              |
| **界限符**     |            |                          |                |
| 左括号         | 17         | (                        | -              |
| 右括号         | 18         | )                        | -              |
| 左花括号       | 19         | {                        | -              |
| 右花括号       | 20         | }                        | -              |
| 分号           | 21         | ;                        | -              |
| 逗号           | 22         | ,                        | -              |
| **标识符**     | 23         | [a-zA-Z\_][a-zA-Z0-9_]\* | 符号表指针     |
| **整数常量**   | 24         | [0-9]+                   | 常数表指针     |
| **结束符**     | 25         | #                        | -              |

## 四、词法规则（正规式）

### 基本字符集定义

```
letter → [a-zA-Z]
digit → [0-9]
underscore → _
```

### Token 正规式

| **Token 类型** | **正规式**                                        |
| -------------- | ------------------------------------------------- | -------- |
| 关键字         | if \| else \| while \| int \| return              |
| 标识符         | (letter\|underscore)(letter\|digit\|underscore)\* |
| 整数常量       | digit+                                            |
| 单字符运算符   | + \| - \| \* \| / \| = \| < \| >                  |
| 双字符运算符   | == \| != \| <= \| >=                              |
| 界限符         | ( \| ) \| { \| } \| ; \| ,                        |
| 空白符         | (space \| tab \| newline)+                        |
| 注释           | /\*(.                                             | \n)\*\*/ |
| 结束符         | #                                                 |

### 词法规则优先级

1. **最长匹配原则**：`==` 优先于 `=`，`<=` 优先于 `<`
2. **关键字优先原则**：先检查是否为关键字
3. **空白符跳过**：自动跳过空格、制表符、换行符
4. **注释跳过**：自动跳过 `/* ... */` 块注释

## 五、状态转换图

### 标识符/关键字识别

```
       letter|_
S0 ───────────> S1 <──────┐
                 │        │ letter|digit|_
                 │        │
                 └────────┘
                 │ other (回退)
                 ▼
                F1
```

### 整数常量识别

```
       digit
S0 ───────────> S2 <──────┐
                 │        │ digit
                 │        │
                 └────────┘
                 │ other (回退)
                 ▼
                F2
```

### 运算符识别（以 = 为例）

```
       =          =
S0 ──────> S3 ──────> F4 (==)
            │
            │ other (回退)
            ▼
           F3 (=)
```

### 注释识别

```
       /          *
S0 ──────> S7 ──────> S8 <────┐
            │          │      │ not *
            │          │ *    │
            │          ▼      │
            │         S9 ─────┘
            │          │ /
            │ other    ▼
            ▼         S0
           F3
```

## 六、扫描程序框图

```
开始 → 读取字符 → 判断字符类型 → 识别Token → 输出Token → 判断是否结束
         ↑                                           │
         └───────────────────────────────────────────┘
```

主要步骤：

1. 跳过空白符和注释
2. 根据首字符判断 Token 类型
3. 应用相应的识别算法
4. 生成 Token 并输出
5. 继续直到遇到结束符

## 七、数据结构设计

### Token 结构

```python
class Token:
    type: int           # 类别码
    value: str          # 词素
    line: int           # 行号
    column: int         # 列号
    attr_index: int     # 属性值（符号表/常数表索引）
```

### 符号表结构

```python
class SymbolEntry:
    name: str           # 标识符名称
    index: int          # 索引
```

### 常数表结构

```python
class ConstantEntry:
    value: int          # 常数值
    index: int          # 索引
```

### 关键字表

```python
keywords = {
    'if': 1, 'else': 2, 'while': 3, 'int': 4, 'return': 5
}
```

## 八、测试用例与结果

### 测试用例 1：正确程序（test_correct.mini）

**源代码**：

```c
int a = 3;
int b = 5;
if (a > 1) {
    a = a + 1;
}
while (b < 10) {
    b = b * 2;
}
int result = a + b;
return result;
#
```

**测试结果**：

- 成功识别 49 个 Token
- 符号表：`a`, `b`, `result`（3 个标识符）
- 常数表：`3`, `5`, `1`, `10`, `2`（5 个常量）
- 无错误

### 测试用例 2：错误检测（test_error.mini）

**源代码**：

```c
int x = 5;
int y @ 10;
if (x ! y) {
    x = x $ 2;
}
#
```

**测试结果**：

- 检测到 3 个错误：
  - 错误 (行 2, 列 7): 非法字符 '@'
  - 错误 (行 3, 列 8): 非法字符 '!'，期望 '!='
  - 错误 (行 4, 列 11): 非法字符 '$'
- 成功识别 36 个有效 Token
- 错误后继续分析

### 测试用例 3：注释处理（test_comment.mini）

**源代码**：

```c
/* 这是一个测试程序 */
int a = 10;
/* 计算 a 的值 */
a = a + 5;
#
```

**测试结果**：

- 成功跳过所有注释
- 识别 22 个有效 Token
- 符号表：`a`, `b`
- 常数表：`10`, `5`, `2`
- 无错误

### 测试用例 4：运算符测试（test_operators.mini）

**测试目的**：测试所有运算符的识别，特别是双字符运算符

**测试结果**：

- 正确识别所有单字符运算符：`+`, `-`, `*`, `/`, `=`, `<`, `>`
- 正确识别所有双字符运算符：`==`, `!=`, `<=`, `>=`
- 最长匹配原则正确应用

## 九、实验总结

### 实现的功能

1. **完整的词法分析**：识别所有 Mini 语言的词法单元
2. **符号表管理**：自动维护标识符符号表，支持去重
3. **常数表管理**：自动维护常数表，支持去重
4. **注释处理**：正确跳过块注释 `/* ... */`
5. **错误检测**：检测非法字符和词法错误，提供详细位置信息
6. **位置跟踪**：记录每个 Token 的行号和列号
7. **文件输入输出**：支持从文件读取源代码，输出结果到文件

### 技术特点

1. **基于 DFA**：使用有限自动机理论实现
2. **最长匹配**：优先匹配更长的 Token
3. **前瞻机制**：使用 `peek()` 方法前瞻字符
4. **错误恢复**：遇到错误后继续分析
5. **高效查找**：关键字使用哈希表，O(1) 查找

### 算法复杂度

- **时间复杂度**：O(n)，n 为源代码长度
- **空间复杂度**：O(m + k)，m 为标识符数，k 为常量数

### 实验收获

1. 深入理解了词法分析的原理和实现方法
2. 掌握了正规式到 DFA 的转换过程
3. 学会了符号表等数据结构的设计
4. 提高了错误处理和调试能力
5. 熟悉了编译器前端的工作流程

### 可能的改进

1. 支持更多数据类型（浮点数、字符串）
2. 支持单行注释 `//`
3. 优化符号表查找（使用哈希表）
4. 添加更详细的错误恢复机制
5. 支持更多运算符和关键字

## 十、使用说明

### 运行方法

```bash
python lexical_analyzer.py <源文件> [输出文件]
```

### 示例

```bash
python lexical_analyzer.py test_correct.mini output.txt
```

### 输出格式

- Token 序列：`<类别码, '词素', Line:行号, Col:列号, Index:索引>`
- 符号表：`[索引] 标识符名称`
- 常数表：`[索引] 常数值`
- 错误列表：`错误 (行 X, 列 Y): 错误信息`

## 附录：完整代码

完整代码见 `lexical_analyzer.py` 文件，包含：

- TokenType 枚举类
- Token 类
- SymbolEntry 和 ConstantEntry 类
- LexicalAnalyzer 主类
- 主函数和命令行接口

---

**实验完成日期**：2024 年
**编程语言**：Python 3
**代码行数**：约 400 行
